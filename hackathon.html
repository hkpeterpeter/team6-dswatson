
<!DOCTYPE html>
<!-- https://stackoverflow.com/questions/42720488/d3-v4-drag-line-chart-with-x-and-y-axes -->
<!-- Thanks to Mark - https://stackoverflow.com/users/16363/mark -->

<img src="price_elastic.png" style="width:700px;" />
<h3>Demand Curve in Oct: Profit(x-axis) / Quantity(y-axis)</h3>
<svg width="500" height="350"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

//d3.select("body").transition()
  //  .style("background-color", "black");

var svg = d3.select("svg"),
    margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = +svg.attr("width") - margin.left - margin.right,
    height = +svg.attr("height") - margin.top - margin.bottom;


/*let points = d3.range(1, 10).map(function(i) {
    return [i * width / 10, 50 + Math.random() * (height - 100)];
});
*/

let points = [
	[0,100],
	[1,200],
	[2,500],
	[3,300]
	,[4,600]
	,[5,200]
];

// Movable points
let point = [2.5, 400];
let point2 = [2, 500];
let point3 = [3, 300];


function mapToY(points, xx) {

  var yy = -1;
	for (var i=0; i<points.length; i++) {
		if ( points[i][0] > xx ) {

			var x0 = points[i-1][0];
			var y0 = points[i-1][1];
			var x1 = points[i][0];
			var y1 = points[i][1];

			var yy = y0 + (xx-x0)*(y1-y0)/(x1-x0);

			//var rangeY = point[i][1] - point[i-1][1];
			//var rangeX = point[i][0] - point[i-1][0];
			//var dx1 = inputX - point[i-1][0];
			//var dx2 = point[i][0] - inputX;

			console.log(" i: " + i + " x: " + xx + " y: " +  yy);
			break;

		}
	}
	return yy;
}


var x = d3.scaleLinear()
    .rangeRound([0, width]);

var y = d3.scaleLinear()
    .rangeRound([height, 0]);

var xAxis = d3.axisBottom(x),
    yAxis = d3.axisLeft(y);

var line = d3.line()
    .x(function(d) { return x(d[0]); })
    .y(function(d) { return y(d[1]); });

let drag = d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended);

svg.append('rect')
    .attr('class', 'zoom')
    .attr('cursor', 'move')
    .attr('fill', 'none')
    .attr('pointer-events', 'all')
    .attr('width', width)
    .attr('height', height)
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')

 var focus = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

x.domain(d3.extent(points, function(d) { return d[0]; }));
y.domain(d3.extent(points, function(d) { return d[1]; }));

focus.append("path")
    .datum(points)
    .attr("fill", "none")
    .attr("stroke", "steelblue")
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 1.5)
    .attr("d", line);

/*focus.append("path")
	.datum([points[0], points[3]])
	.attr("fill", "none")
	.attr("stroke", "steelblue")
	.attr("stroke-linejoin", "round")
	.attr("stroke-linecap", "round")
	.attr("stroke-width", 1.5)
	.attr("d", line);*/

  // Point 1: control line 1
	focus.append("path")
			.datum( [  [0, point[1]], point ] )
			.attr("id","controlLineY")
			.attr("fill", "none")
			.attr("stroke", "red")
			.attr("stroke-linejoin", "round")
			.attr("stroke-linecap", "round")
			.attr("stroke-width", 1.5)
			.attr("stroke-dasharray", "5,5")
			.attr("d", line);

// Test: Add a text label
/*
focus.append("text")
    .data( [  [0, point[1]], point ] )
    .attr("id","controlTextLineY")
.attr("x", function(d) { return d.cx; })
                 .attr("y", function(d) { return d.cy; })
                 .text( function (d) { return "( " + d.cx + ", " + d.cy +" )"; })
                 .attr("font-family", "sans-serif")
                 .attr("font-size", "20px")
                 .attr("fill", "red");*/



// Point 1: Extended control line 1
      focus.append("path")
    			.datum( [  [0, point[1]*0.95], [point[0], point[1]*0.95] ] )
    			.attr("id","controlExtendedLineY")
    			.attr("fill", "none")
    			.attr("stroke", "red")
    			.attr("stroke-linejoin", "round")
    			.attr("stroke-linecap", "round")
    			.attr("stroke-width", 1.5)
    			.attr("stroke-dasharray", "5,5")
    			.attr("d", line);



  // Point 1: control line 2
	focus.append("path")
					.datum( [  [point[0], 0] , point ] )
					.attr("id","controlLineX")
					.attr("fill", "none")
					.attr("stroke", "red")
					.attr("stroke-linejoin", "round")
					.attr("stroke-linecap", "round")
					.attr("stroke-width", 1.5)
					.attr("stroke-dasharray", "5,5")
					.attr("d", line);





  // Point 2: control line 1
  focus.append("path")
        	.datum( [  [0, point2[1]], point2 ] )
        	.attr("id","control2LineY")
        	.attr("fill", "none")
        	.attr("stroke", "green")
        	.attr("stroke-linejoin", "round")
        	.attr("stroke-linecap", "round")
        	.attr("stroke-width", 1.5)
        	.attr("stroke-dasharray", "5,15")
        	.attr("d", line);

   // Point 2: control line 2
  focus.append("path")
        					.datum( [  [point2[0], 0] , point2 ] )
        					.attr("id","control2LineX")
        					.attr("fill", "none")
        					.attr("stroke", "green")
        					.attr("stroke-linejoin", "round")
        					.attr("stroke-linecap", "round")
        					.attr("stroke-width", 1.5)
        					.attr("stroke-dasharray", "5,15")
        					.attr("d", line);

  // Point 2: control line 1
  focus.append("path")
          .datum( [  [0, point3[1]], point3 ] )
          .attr("id","control3LineY")
          .attr("fill", "none")
                        	.attr("stroke", "purple")
                        	.attr("stroke-linejoin", "round")
                        	.attr("stroke-linecap", "round")
                        	.attr("stroke-width", 1.5)
                        	.attr("stroke-dasharray", "5,15")
                        	.attr("d", line);

  // Point 2: control line 2
                  focus.append("path")
                        					.datum( [  [point3[0], 0] , point3 ] )
                        					.attr("id","control3LineX")
                        					.attr("fill", "none")
                        					.attr("stroke", "purple")
                        					.attr("stroke-linejoin", "round")
                        					.attr("stroke-linecap", "round")
                        					.attr("stroke-width", 1.5)
                        					.attr("stroke-dasharray", "5,15")
                        					.attr("d", line);







// Movable circles
focus.selectAll('circle')
    .data([point, point2, point3])
    .enter()
    .append('circle')
    .attr('r', 5.0)
    .attr('cx', function(d) { return x(d[0]);  })
    .attr('cy', function(d) { return y(d[1]); })
    .style('cursor', 'pointer')
    .style('fill', 'steelblue');
focus.selectAll('circle').call(drag);







focus.append('g')
    .attr('class', 'axis axis--x')
    .attr('transform', 'translate(0,' + height + ')')
    .call(xAxis);

focus.append('g')
    .attr('class', 'axis axis--y')
    .call(yAxis);

function dragstarted(d) {
    d3.select(this).raise().classed('active', true);
}

function dragged(d) {
    d[0] = x.invert(d3.event.x);
  	//d[1] = y.invert(d3.event.y);
		d[1] = mapToY(points, d[0]);


    d3.select(this)
        .attr('cx', x(d[0]))
        .attr('cy', y(d[1]))
    focus.select('path').attr('d', line);


		focus.select('path#controlLineY').remove();
		focus.append("path")
				.datum( [  [0, point[1]], point ] )
				.attr("id","controlLineY")
				.attr("fill", "none")
				.attr("stroke", "red")
				.attr("stroke-linejoin", "round")
				.attr("stroke-linecap", "round")
				.attr("stroke-width", 1.5)
				.attr("stroke-dasharray", "5,5")
				.attr("d", line);

focus.select('path#controlLineX').remove();
				focus.append("path")
								.datum( [  [point[0], 0] , point ] )
								.attr("id","controlLineX")
								.attr("fill", "none")
								.attr("stroke", "red")
								.attr("stroke-linejoin", "round")
								.attr("stroke-linecap", "round")
								.attr("stroke-width", 1.5)
								.attr("stroke-dasharray", "5,5")
								.attr("d", line);


                // Point 1: Extended control line 1
                focus.select('path#controlExtendedLineY').remove();
                      focus.append("path")
                    			.datum( [  [0, point[1]*0.95], [point[0], point[1]*0.95] ] )
                    			.attr("id","controlExtendedLineY")
                    			.attr("fill", "none")
                    			.attr("stroke", "red")
                    			.attr("stroke-linejoin", "round")
                    			.attr("stroke-linecap", "round")
                    			.attr("stroke-width", 1.5)
                    			.attr("stroke-dasharray", "5,5")
                    			.attr("d", line);


}

function dragended(d) {
    d3.select(this).classed('active', false);
}

</script>
